import{_ as U,n as V,E as B,r as i,l as I,j as M,c as l,a as t,d as y,A as F,C as P,t as o,s as T,F as L,y as N,o as n,B as j}from"./BxhkHZUn.js";const G={class:"admin-container"},q={class:"header-section"},z={class:"action-buttons"},H=["disabled"],J={key:0,class:"fas fa-spinner fa-spin"},K={key:1,class:"fas fa-sync-alt"},Q=["disabled"],W={key:0,class:"fas fa-spinner fa-spin"},X={key:1,class:"fas fa-search"},Y=["disabled"],Z={key:0,class:"fas fa-spinner fa-spin"},ee={key:1,class:"fas fa-trash"},te={class:"filter-section"},se={class:"filter-group"},le=["disabled"],ne={key:0,class:"loading-container"},ae={key:1,class:"error-container"},oe={class:"error-message"},re={key:2},ue={key:0,class:"empty-state"},ie={key:1,class:"results-section"},de={class:"results-header"},ce=["disabled"],ve={key:0,class:"fas fa-spinner fa-spin"},fe={key:1,class:"fas fa-trash"},he={class:"admin-table"},pe=["checked"],me=["value"],ye=["onClick","disabled"],_e={key:0,class:"fas fa-spinner fa-spin"},be={key:1,class:"fas fa-trash"},ge={key:2,class:"cleanup-results"},we={class:"results-info"},ke={key:0,class:"preview-list"},Ce={__name:"not-found-transactions",setup(Ee){const{user:u}=V(),{success:k,error:C}=B(),c=i([]),v=i(!0),_=i(null),b=i(7),f=i(!1),h=i(!0),d=i(null),r=i([]),m=i(!1),g=i({}),x=I(()=>c.value.length>0&&r.value.length===c.value.length),S=()=>{x.value?r.value=[]:r.value=c.value.map(s=>s.id)},p=async()=>{v.value=!0,_.value=null,d.value=null;try{if(!u.value||!u.value.id)throw new Error("User not authenticated.");const s=await $fetch("/api/admin/tables/transactions",{headers:{"x-user-id":u.value.id,"x-user-email":u.value.email},params:{filter:"payment_gateway_status=not_found_in_gateway",sort:"updated_at:desc"}});if(s.success)c.value=s.data.records||[],r.value=[];else throw new Error(s.message||"Failed to fetch transactions.")}catch(s){console.error("Error fetching transactions:",s),_.value=s.message||"An unexpected error occurred."}finally{v.value=!1}},D=async(s=!0)=>{f.value=!0,h.value=s,d.value=null;try{if(!u.value||!u.value.id)throw new Error("User not authenticated.");const e=await $fetch("/api/admin/cleanup-not-found-transactions",{headers:{"x-user-id":u.value.id,"x-user-email":u.value.email},params:{days:b.value,dry_run:s}});if(e.success)d.value=e.data,!s&&e.data.deleted>0&&(k(`Successfully deleted ${e.data.deleted} transactions`),p());else throw new Error(e.message||"Failed to run cleanup.")}catch(e){console.error("Error running cleanup:",e),C(e.message||"An unexpected error occurred.")}finally{f.value=!1}},O=async s=>{if(confirm("Are you sure you want to delete this transaction? This action cannot be undone.")){g.value[s]=!0;try{const e=await $fetch(`/api/admin/tables/transactions/${s}`,{method:"DELETE",headers:{"x-user-id":u.value.id,"x-user-email":u.value.email}});if(e.success)k("Transaction deleted successfully"),r.value=r.value.filter(w=>w!==s),p();else throw new Error(e.message||"Failed to delete transaction")}catch(e){console.error("Error deleting transaction:",e),C(e.message||"An error occurred while deleting the transaction")}finally{g.value[s]=!1}}},R=async()=>{if(r.value.length!==0&&confirm(`Are you sure you want to delete ${r.value.length} transactions? This action cannot be undone.`)){m.value=!0;try{for(const s of r.value)try{await $fetch(`/api/admin/tables/transactions/${s}`,{method:"DELETE",headers:{"x-user-id":u.value.id,"x-user-email":u.value.email}})}catch(e){console.error(`Error deleting transaction ${s}:`,e)}k(`${r.value.length} transactions deleted successfully`),p()}catch(s){console.error("Error deleting selected transactions:",s),C("An error occurred while deleting the selected transactions")}finally{m.value=!1}}},A=s=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(s),E=s=>new Date(s).toLocaleString();return M(async()=>{await p()}),(s,e)=>{var w;return n(),l("div",G,[t("div",q,[e[7]||(e[7]=t("h1",{class:"page-title"},"Not Found in Gateway Transactions",-1)),t("div",z,[t("button",{onClick:p,class:"admin-button refresh-btn",disabled:v.value},[v.value?(n(),l("i",J)):(n(),l("i",K)),e[4]||(e[4]=y(" Refresh "))],8,H),t("button",{onClick:e[0]||(e[0]=a=>D(!0)),class:"admin-button preview-btn",disabled:v.value||f.value},[f.value&&h.value?(n(),l("i",W)):(n(),l("i",X)),e[5]||(e[5]=y(" Preview Cleanup "))],8,Q),t("button",{onClick:e[1]||(e[1]=a=>D(!1)),class:"admin-button danger-btn",disabled:v.value||f.value},[f.value&&!h.value?(n(),l("i",Z)):(n(),l("i",ee)),e[6]||(e[6]=y(" Run Cleanup "))],8,Y)])]),t("div",te,[t("div",se,[e[8]||(e[8]=t("label",{for:"daysOld"},"Days Old:",-1)),F(t("input",{type:"number",id:"daysOld","onUpdate:modelValue":e[2]||(e[2]=a=>b.value=a),min:"1",max:"365",class:"admin-input",disabled:f.value},null,8,le),[[P,b.value]])])]),v.value?(n(),l("div",ne,e[9]||(e[9]=[t("div",{class:"spinner"},null,-1),t("p",null,"Loading transactions...",-1)]))):_.value?(n(),l("div",ae,[t("p",oe,o(_.value),1),t("button",{onClick:p,class:"admin-button"},"Try Again")])):(n(),l("div",re,[c.value.length===0?(n(),l("div",ue,e[10]||(e[10]=[t("p",null,'No transactions with "not_found_in_gateway" status found.',-1)]))):(n(),l("div",ie,[t("div",de,[t("h2",null,o(c.value.length)+" Transactions Found",1),r.value.length>0?(n(),l("button",{key:0,onClick:R,class:"admin-button danger-btn",disabled:m.value},[m.value?(n(),l("i",ve)):(n(),l("i",fe)),y(" Delete Selected ("+o(r.value.length)+") ",1)],8,ce)):T("",!0)]),t("table",he,[t("thead",null,[t("tr",null,[t("th",null,[t("input",{type:"checkbox",checked:x.value,onChange:S,class:"checkbox"},null,40,pe)]),e[11]||(e[11]=t("th",null,"ID",-1)),e[12]||(e[12]=t("th",null,"Order ID",-1)),e[13]||(e[13]=t("th",null,"Product",-1)),e[14]||(e[14]=t("th",null,"Email",-1)),e[15]||(e[15]=t("th",null,"Amount",-1)),e[16]||(e[16]=t("th",null,"Created",-1)),e[17]||(e[17]=t("th",null,"Updated",-1)),e[18]||(e[18]=t("th",null,"Actions",-1))])]),t("tbody",null,[(n(!0),l(L,null,N(c.value,a=>(n(),l("tr",{key:a.id},[t("td",null,[F(t("input",{type:"checkbox",value:a.id,"onUpdate:modelValue":e[3]||(e[3]=$=>r.value=$),class:"checkbox"},null,8,me),[[j,r.value]])]),t("td",null,o(a.id),1),t("td",null,o(a.order_id),1),t("td",null,o(a.product_name),1),t("td",null,o(a.email),1),t("td",null,o(A(a.amount)),1),t("td",null,o(E(a.created_at)),1),t("td",null,o(E(a.updated_at)),1),t("td",null,[t("button",{onClick:$=>O(a.id),class:"admin-button small danger-btn",disabled:m.value||g.value[a.id]},[g.value[a.id]?(n(),l("i",_e)):(n(),l("i",be))],8,ye)])]))),128))])])])),d.value?(n(),l("div",ge,[e[20]||(e[20]=t("h3",null,"Cleanup Results",-1)),t("div",we,[t("p",null,[t("strong",null,o(h.value?"Preview Mode:":"Cleanup Completed:"),1),y(" "+o(d.value.count||d.value.deleted)+" transactions "+o(h.value?"would be":"were")+" deleted ",1)]),t("p",null,[t("small",null,"Transactions older than "+o(b.value)+' days with "not_found_in_gateway" status',1)])]),h.value&&((w=d.value.transactions)==null?void 0:w.length)>0?(n(),l("div",ke,[e[19]||(e[19]=t("h4",null,"Transactions that would be deleted:",-1)),t("ul",null,[(n(!0),l(L,null,N(d.value.transactions,a=>(n(),l("li",{key:a.id}," ID: "+o(a.id)+" - "+o(a.product_name)+" - "+o(A(a.amount))+" - "+o(E(a.updated_at)),1))),128))])])):T("",!0)])):T("",!0)]))])}}},xe=U(Ce,[["__scopeId","data-v-ccfbbe62"]]);export{xe as default};

import{_ as A,N as V,r as _,l as E,j as $,u as S,c as r,a as s,d as y,M as I,s as C,A as v,S as T,F as k,y as w,t as n,C as m,o as d,E as U}from"./BxhkHZUn.js";const D={class:"add-license-page"},Q={class:"form-container"},B={class:"form-group"},M=["value"],O={class:"form-group"},J={class:"form-row"},R={class:"form-group"},j={for:"licenseEmail"},G=["required","disabled","placeholder"],H={class:"form-group"},z={for:"licensePassword"},W=["required","disabled","placeholder"],X={class:"form-row"},Y={class:"form-group"},Z=["for"],x=["id","value","placeholder","onInput"],ee={class:"form-group"},le=["for"],se=["id","value","placeholder","onInput"],te={class:"form-group"},ae={for:"licenseKey"},oe=["required","disabled","placeholder"],ie=["for"],ne=["id","value","onInput"],ue={class:"form-group"},re=["disabled","placeholder"],de={class:"form-hint"},ce={class:"form-actions"},pe=["disabled"],ve={key:0},ye={key:1},fe={__name:"add-license",setup(_e){const b=V(),l=_({product_id:"",license_type:"",email:"",password:"",license_key:"",quantity:1}),o=_([]),h=_([]),f=_(!1),c=E(()=>l.value.license_type==="product_key"),p=E(()=>l.value.license_type==="email_password"),F=async()=>{try{const a=await $fetch("/api/admin/tables/products");a&&a.success&&(h.value=a.data||[])}catch(a){console.error("Error loading products:",a)}},g=()=>{const a=l.value.quantity||1,t=a-1;console.log("updateQuantityFields called. Quantity:",a,"Target length:",t,"Current length:",o.value.length);const e=[];for(let i=0;i<t;i++)o.value[i]?e.push({...o.value[i]}):e.push({license_key:"",email:"",password:""});o.value=e,console.log("Updated quantityFields:",o.value)},q=(a,t,e)=>{console.log("=== UPDATING FIELD ==="),console.log("Index:",a,"Field:",t,"Value:",e),console.log("Current quantityFields before update:",JSON.stringify(o.value)),o.value[a]||(o.value[a]={license_key:"",email:"",password:""}),o.value[a][t]=e,console.log("Current quantityFields after update:",JSON.stringify(o.value)),console.log("=== END UPDATE ===")},K=()=>{console.log("License type changed to:",l.value.license_type),l.value.email="",l.value.password="",l.value.license_key="",l.value.license_type==="email_password"&&(l.value.license_key=""),g()},N=async()=>{f.value=!0;try{const a=U();if(!l.value.product_id||!l.value.license_type){a.error("Please fill in all required fields");return}if(!l.value.quantity||l.value.quantity<1||l.value.quantity>100){a.error("Quantity must be between 1 and 100");return}if(l.value.license_type==="product_key"){if(!l.value.license_key||!l.value.license_key.trim()){a.error("License key is required for Product Key type");return}if(l.value.quantity>1){console.log("Validating additional license keys. quantityFields:",o.value);for(let e=0;e<l.value.quantity-1;e++){const i=o.value[e],u=i?i.license_key:null;if(console.log(`Validating License #${e+2}: field=`,i,"licenseKey=",u),!i||!u||!u.trim()){console.error(`Validation failed for License #${e+2}`),a.error(`License key is required for License #${e+2}`);return}}console.log("All additional license keys validated successfully")}}if(l.value.license_type==="email_password"){if(!l.value.email||!l.value.password){a.error("Email and password are required for Account type");return}if(l.value.quantity>1){for(let e=0;e<l.value.quantity-1;e++)if(!o.value[e]||!o.value[e].email||!o.value[e].password){a.error(`Email and password are required for Account #${e+2}`);return}}}a.info("Creating licenses...",2e3);let t=0;for(let e=0;e<l.value.quantity;e++){const i={product_id:l.value.product_id,license_type:l.value.license_type,status:"available"};if(l.value.license_type==="product_key")if(e===0)i.license_key=l.value.license_key.trim();else{const P=o.value[e-1]?o.value[e-1].license_key:"";console.log(`License ${e+1}: checking quantityFields[${e-1}]:`,o.value[e-1],"userKey:",P),i.license_key=P.trim()}else l.value.license_type==="email_password"&&(e===0?(i.email=l.value.email,i.password=l.value.password):(i.email=o.value[e-1].email,i.password=o.value[e-1].password));console.log("Sending license data:",i);const u=await $fetch("/api/admin/product-licenses",{method:"POST",body:i});if(u&&u.success)t++,a.info(`License ${e+1} of ${l.value.quantity} created`,1e3);else throw new Error(`Failed to create license ${e+1}: ${(u==null?void 0:u.message)||"Unknown error"}`)}a.success(`Successfully created ${t} licenses!`),console.log("=== License Creation Complete - Check logs above ==="),console.log("Redirecting to dashboard in 3 seconds..."),setTimeout(()=>{b.push("/dashboard")},3e3)}catch(a){console.error("Error creating license:",a),toast.error("Error creating license: "+a.message)}finally{f.value=!1}},L=()=>{b.push("/dashboard")};return $(async()=>{await F(),g()}),S({title:"Add New License - Admin"}),(a,t)=>(d(),r("div",D,[s("div",{class:"page-header"},[t[7]||(t[7]=s("h1",null,[s("i",{class:"fas fa-key"}),y(" Add New License")],-1)),s("button",{onClick:L,class:"back-btn"},t[6]||(t[6]=[s("i",{class:"fas fa-arrow-left"},null,-1),y(" Back to Dashboard ")]))]),s("div",Q,[s("form",{onSubmit:I(N,["prevent"]),class:"license-form"},[s("div",B,[t[9]||(t[9]=s("label",{for:"productSelect"},"Select Product *",-1)),v(s("select",{id:"productSelect","onUpdate:modelValue":t[0]||(t[0]=e=>l.value.product_id=e),required:""},[t[8]||(t[8]=s("option",{value:""},"Choose Product",-1)),(d(!0),r(k,null,w(h.value,e=>(d(),r("option",{key:e.id,value:e.id},n(e.name),9,M))),128))],512),[[T,l.value.product_id]])]),s("div",O,[t[11]||(t[11]=s("label",{for:"licenseType"},"License Type *",-1)),v(s("select",{id:"licenseType","onUpdate:modelValue":t[1]||(t[1]=e=>l.value.license_type=e),required:"",onChange:K},t[10]||(t[10]=[s("option",{value:""},"Choose License Type",-1),s("option",{value:"product_key"},"Product Key",-1),s("option",{value:"email_password"},"Account (Email & Password)",-1)]),544),[[T,l.value.license_type]])]),s("div",J,[s("div",R,[s("label",j,"Email"+n(p.value?" *":""),1),v(s("input",{type:"email",id:"licenseEmail","onUpdate:modelValue":t[2]||(t[2]=e=>l.value.email=e),required:p.value,disabled:!l.value.product_id||!l.value.license_type||c.value,placeholder:!l.value.product_id||!l.value.license_type?"Please select Product and License Type first":c.value?"Not required for Product Key":"Enter user email"},null,8,G),[[m,l.value.email]])]),s("div",H,[s("label",z,"Password"+n(p.value?" *":""),1),v(s("input",{type:"password",id:"licensePassword","onUpdate:modelValue":t[3]||(t[3]=e=>l.value.password=e),required:p.value,disabled:!l.value.product_id||!l.value.license_type||c.value,placeholder:!l.value.product_id||!l.value.license_type?"Please select Product and License Type first":c.value?"Not required for Product Key":"Enter password"},null,8,W),[[m,l.value.password]])])]),l.value.quantity>1&&p.value?(d(!0),r(k,{key:0},w(l.value.quantity-1,e=>(d(),r("div",{key:"account-"+e},[s("div",X,[s("div",Y,[s("label",{for:"email"+(e+1)}," Email #"+n(e+1)+" * ",9,Z),s("input",{id:"email"+(e+1),type:"email",value:o.value[e-1]?o.value[e-1].email:"",required:"",placeholder:"Enter email for account #"+(e+1),onInput:i=>q(e-1,"email",i.target.value)},null,40,x)]),s("div",ee,[s("label",{for:"password"+(e+1)}," Password #"+n(e+1)+" * ",9,le),s("input",{id:"password"+(e+1),type:"password",value:o.value[e-1]?o.value[e-1].password:"",required:"",placeholder:"Enter password for account #"+(e+1),onInput:i=>q(e-1,"password",i.target.value)},null,40,se)])])]))),128)):C("",!0),s("div",te,[s("label",ae," License Key "+n(c.value?"*":"(Not applicable for Account type)"),1),v(s("input",{type:"text",id:"licenseKey","onUpdate:modelValue":t[4]||(t[4]=e=>l.value.license_key=e),required:c.value,disabled:!l.value.product_id||!l.value.license_type||p.value,placeholder:!l.value.product_id||!l.value.license_type?"Please select Product and License Type first":p.value?"Not required for Account type":"Enter your license key"},null,8,oe),[[m,l.value.license_key]])]),l.value.quantity>1&&c.value?(d(!0),r(k,{key:1},w(l.value.quantity-1,e=>(d(),r("div",{key:"key-"+e,class:"form-group"},[s("label",{for:"licenseKey"+(e+1)},"License Key #"+n(e+1)+" *",9,ie),s("input",{id:"licenseKey"+(e+1),type:"text",value:o.value[e-1]?o.value[e-1].license_key:"",required:"",onInput:i=>q(e-1,"license_key",i.target.value)},null,40,ne)]))),128)):C("",!0),s("div",ue,[t[13]||(t[13]=s("label",{for:"quantity"},"Quantity",-1)),v(s("input",{type:"number",id:"quantity","onUpdate:modelValue":t[5]||(t[5]=e=>l.value.quantity=e),min:"1",max:"100",disabled:!l.value.product_id||!l.value.license_type,placeholder:!l.value.product_id||!l.value.license_type?"Please select Product and License Type first":"Number of licenses to create (default: 1)",onInput:g},null,40,re),[[m,l.value.quantity,void 0,{number:!0}]]),s("small",de,[t[12]||(t[12]=s("i",{class:"fas fa-info-circle"},null,-1)),y(" Create "+n(l.value.quantity||1)+" "+n(l.value.license_type==="product_key"?"license keys":"account credentials"),1)])]),s("div",ce,[s("button",{type:"button",onClick:L,class:"cancel-btn"}," Cancel "),s("button",{type:"submit",disabled:f.value,class:"submit-btn"},[f.value?(d(),r("span",ve,t[14]||(t[14]=[s("i",{class:"fas fa-spinner fa-spin"},null,-1),y(" Creating... ")]))):(d(),r("span",ye,[t[15]||(t[15]=s("i",{class:"fas fa-key"},null,-1)),y(" Create "+n(l.value.quantity>1?`${l.value.quantity} Licenses`:"License"),1)]))],8,pe)])],32)])]))}},ge=A(fe,[["__scopeId","data-v-017c165c"]]);export{ge as default};

import{p as oe,_ as le,r as v,k as ne,l as k,m as O,n as ie,u as re,j as ue,q as ce,c,s as g,v as de,a as t,x as ve,t as p,F as D,y as N,z as B,g as x,A as Q,B as pe,C as me,D as fe,d as q,i as ye,o as u}from"./BxhkHZUn.js";import{u as ge}from"./YVwmBCuj.js";import"./DUhoTqhP.js";const he=oe("/qris-logo.png"),_e={key:0,class:"modal-overlay"},be={key:2},ke={class:"checkout-page"},xe={key:0,class:"loading-state"},Pe={key:1,class:"error-state"},Ce={key:2,class:"product-checkout-container"},Ie={class:"checkout-header"},qe={class:"product-name"},we={class:"checkout-grid"},Ee={class:"product-info galaxy-card"},Ve={class:"product-image-container"},Se=["src","alt"],Te={class:"product-details"},Fe=["innerHTML"],Me={key:0,class:"product-features"},$e={class:"checkout-form galaxy-card"},Ae={key:0,class:"form-group"},Be={class:"version-options"},Re=["onClick"],Ue={class:"version-name"},Le={class:"version-price"},Oe={key:0,class:"version-badge"},De={class:"form-group"},Ne=["value","placeholder","disabled"],Qe={class:"simple-checkbox"},je={key:0,class:"error-text"},He={class:"help-text"},Ke={class:"form-group"},Ye={class:"quantity-controls"},Je=["disabled"],ze=["max"],Xe=["disabled"],Ze={class:"stock-info"},Ge={key:0,class:"stock-available"},We={key:1,class:"stock-unavailable"},et={class:"price-summary"},tt={class:"summary-row"},st={class:"price-value"},at={class:"summary-row"},ot={class:"quantity-value"},lt={class:"summary-row total"},nt={class:"total-amount"},it={key:0,class:"savings-indicator"},rt={key:3,class:"no-product-found"},ut={__name:"checkout",setup(ct){const w=ne(),E=ye(),{formatCurrency:V}=ge(),l=v(null),F=v(!0),S=v(null),n=v(1),i=v(null),d=v([]),h=v(""),f=v(!1),_=v(""),P=v(!1),j=s=>{f.value&&(h.value=s.target.value)};console.log("Checkout page loaded with route query:",w.query);async function M(){try{F.value=!0,S.value=null;const s=w.query.productId,e=w.query.slug;if(!s&&!e)throw new Error("Missing product ID or slug in URL");console.log("Fetching product details for:",s?`ID: ${s}`:`Slug: ${e}`);try{const a=await $fetch("/api/products/checkout",{params:{slug:e,productId:s}});if(console.log("API response received:",a),!a||!a.product)throw new Error("Product not found or invalid response format");if(l.value=a.product,a.product.versions&&a.product.versions.length>0)if(d.value=a.product.versions,s){const o=a.product.versions.find(r=>r.id===s);o?i.value=o.id:i.value=a.product.versions[0].id}else i.value=a.product.versions[0].id;else d.value=[{id:l.value.id,name:l.value.name,version:l.value.version,description:l.value.description,price:l.value.price,image_url:l.value.image_url}],i.value=l.value.id}catch(a){throw console.error("API error:",a),new Error(`API error: ${a.message||"Unknown error"}`)}console.log("Product data fetched:",l.value)}catch(s){S.value=s.message||"Failed to load product details",console.error("Error fetching product details:",s)}finally{F.value=!1}}const $=k(()=>{var e;if(!i.value||!d.value.length)return((e=l.value)==null?void 0:e.price)||0;const s=d.value.find(a=>a.id===i.value);return s?s.price:0}),H=k(()=>{var e,a;if(!i.value||!d.value.length)return((e=l.value)==null?void 0:e.description)||"";const s=d.value.find(o=>o.id===i.value);return s?s.description||"":((a=l.value)==null?void 0:a.description)||""}),K=k(()=>{var e,a,o;if(!i.value||!d.value.length)return((e=l.value)==null?void 0:e.image_url)||"/placeholder-grey.svg";const s=d.value.find(r=>r.id===i.value);return s?s.image_url||((a=l.value)==null?void 0:a.image_url)||"/placeholder-grey.svg":((o=l.value)==null?void 0:o.image_url)||"/placeholder-grey.svg"}),R=k(()=>{var e,a;if(!i.value||!d.value.length)return((e=l.value)==null?void 0:e.name)||"";const s=d.value.find(o=>o.id===i.value);return s?s.name:((a=l.value)==null?void 0:a.name)||""}),U=k(()=>{if(!i.value||!d.value.length)return[];const e=d.value.find(a=>a.id===i.value).description.match(/Features:(.*?)(?:\n\n|$)/s);return e&&e[1]?e[1].trim().split(`
`).map(o=>o.replace(/^[-•*]\s*/,"").trim()).filter(o=>o):[]}),A=v(0),C=v(1),y=k(()=>{if(!i.value||!d.value.length)return 0;const s=d.value.find(e=>e.id===i.value);return s&&s.available_stock||0});O(()=>w.query,s=>{(s.productId||s.slug)&&M()},{immediate:!0}),O($,()=>{P.value||b()});const Y=s=>{i.value=s.id,n.value>s.available_stock&&(n.value=Math.max(1,s.available_stock)),b()},J=()=>{n.value<y.value&&(n.value++,b())},z=()=>{n.value>1&&(n.value--,b())},b=()=>{n.value<1?n.value=1:n.value>y.value&&(n.value=y.value),C.value=n.value,A.value=$.value*n.value,P.value=!1},X=()=>{P.value=!1},Z=()=>{P.value=!0},G=s=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s),W=()=>{if(_.value="",f.value){if(!h.value.trim())return _.value="Custom email is required when this option is selected",!1;if(!G(h.value))return _.value="Please enter a valid email address",!1}return!0},ee=async()=>{if(console.log("🚀 Starting payment initiation..."),!m.value){console.error("❌ No user data found - authentication required"),alert("You must be logged in to complete a purchase. Please log in first."),I.value=!0;return}if(console.log("👤 User authenticated:",{id:m.value.id,name:m.value.name,email:m.value.email}),console.log("📋 User session data for header:",JSON.stringify(m.value)),!l.value||n.value<1){console.error("❌ Invalid product or quantity"),alert("Please select a valid quantity.");return}if(y.value<=0){console.error("❌ Product out of stock"),alert("This product is currently out of stock.");return}if(n.value>y.value){console.error("❌ Insufficient stock"),alert(`Only ${y.value} licenses available. Please reduce quantity.`);return}if(!W()){console.error("❌ Form validation failed");return}const s=d.value.find(e=>e.id===i.value);if(!s){console.error("❌ No valid product version selected"),alert("Please select a valid product version.");return}try{const e={product:{id:s.id,name:l.value.name,version:s.version,price:s.price,category:l.value.category},customer:{name:m.value.name,email:m.value.email},quantity:n.value,custom_email:f.value?h.value.trim():null};console.log("📦 Request body prepared:",e),console.log("🔐 Sending authentication headers with user session");const a=await $fetch("/api/checkout/initiate",{method:"POST",headers:{"Content-Type":"application/json","x-user-session":JSON.stringify(m.value)},body:e});a.token?(a.order_id&&(localStorage.setItem("currentOrderId",a.order_id),sessionStorage.setItem("currentOrderId",a.order_id)),window.snap.pay(a.token,{onSuccess:function(o){console.log("Payment successful!",o),setTimeout(()=>{E.push({path:"/payment/finish",query:{order_id:o.order_id,status_code:o.status_code,transaction_status:o.transaction_status}})},5e3)},onPending:function(o){console.log("Payment pending",o),E.push({path:"/payment/unfinish",query:{order_id:o.order_id,status_code:o.status_code,transaction_status:o.transaction_status}})},onError:function(o){console.error("Payment failed",o),E.push({path:"/payment/error",query:{order_id:o.order_id,status_code:o.status_code,transaction_status:o.transaction_status}})},onClose:function(){console.log("Payment window closed by user.");const o=localStorage.getItem("currentOrderId");E.push({path:"/payment/unfinish",query:{order_id:o||"",reason:"user_closed_popup"}})}})):alert("Failed to get payment token.")}catch(e){console.error("Error initiating payment:",e),alert("Error initiating payment: "+(e.message||"Unknown error"))}},{user:m,initUser:te}=ie(),I=v(!1),T=v(!1),se=()=>{T.value=!0},ae=()=>{T.value=!1,m.value&&(I.value=!1)};return re({title:"Checkout"}),ue(()=>{if(te(),m.value?(f.value=!1,h.value=""):I.value=!0,M(),!document.getElementById("midtrans-snap-script")){const s="https://app.sandbox.midtrans.com/snap/snap.js",a=ce().public.midtransClientKey||"SB-Mid-client-XZVBXJmESkGTZlFP";let o=document.createElement("script");o.id="midtrans-snap-script",o.src=s,o.setAttribute("data-client-key",a),document.body.appendChild(o)}if(!document.getElementById("midtrans-official-script")){const s=document.createElement("script");s.id="midtrans-official-script",s.src="/midtrans-official.js",s.async=!0,document.body.appendChild(s)}}),(s,e)=>{var a,o;return u(),c("div",null,[I.value?(u(),c("div",_e,[t("div",{class:"modal-content"},[e[4]||(e[4]=t("h2",null,"Login Required",-1)),e[5]||(e[5]=t("p",null,"You must log in first to proceed with the product purchase.",-1)),t("button",{class:"cosmic-button",onClick:se},"Login")])])):g("",!0),T.value?(u(),de(ve,{key:1,"is-open":T.value,"default-tab":"login",onClose:ae},null,8,["is-open"])):g("",!0),I.value?g("",!0):(u(),c("div",be,[t("div",ke,[F.value?(u(),c("div",xe,e[6]||(e[6]=[t("div",{class:"loading-spinner"},null,-1),t("p",null,"Loading product details...",-1)]))):S.value?(u(),c("div",Pe,[e[7]||(e[7]=t("div",{class:"error-icon"},"!",-1)),e[8]||(e[8]=t("h2",null,"Error",-1)),t("p",null,p(S.value),1),t("button",{class:"galaxy-button-primary retry-btn",onClick:M},"Try Again")])):l.value?(u(),c("div",Ce,[t("div",Ie,[e[9]||(e[9]=t("h1",null,"Complete Your Purchase",-1)),t("p",qe,p(R.value),1)]),t("div",we,[t("div",Ee,[t("div",Ve,[t("img",{src:K.value,alt:R.value,class:"product-image",onError:e[0]||(e[0]=r=>r.target.src="/placeholder-grey.svg")},null,40,Se)]),t("div",Te,[t("div",{class:"product-description",innerHTML:H.value},null,8,Fe),U.value.length>0?(u(),c("div",Me,[e[10]||(e[10]=t("h3",null,"Features",-1)),t("ul",null,[(u(!0),c(D,null,N(U.value,(r,L)=>(u(),c("li",{key:L},p(r),1))),128))])])):g("",!0)])]),t("div",$e,[e[24]||(e[24]=t("h2",null,"Order Summary",-1)),d.value.length>0?(u(),c("div",Ae,[e[11]||(e[11]=t("label",{for:"version"},"Select Version",-1)),t("div",Be,[(u(!0),c(D,null,N(d.value,r=>(u(),c("button",{key:r.id,class:B(["version-btn",{active:i.value===r.id}]),onClick:L=>Y(r)},[t("span",Ue,p(r.name),1),t("span",Le,p(x(V)(r.price)),1),r.version==="365"?(u(),c("span",Oe,"Subscription")):g("",!0)],10,Re))),128))])])):g("",!0),t("div",De,[e[13]||(e[13]=t("label",{for:"emailInput"},"Email for License Delivery",-1)),t("input",{type:"email",id:"emailInput",value:f.value?h.value:((a=x(m))==null?void 0:a.email)||"",onInput:j,placeholder:f.value?"Enter custom email address":"Your registered email",class:B(["form-input",{error:_.value}]),disabled:!f.value},null,42,Ne),t("div",Qe,[Q(t("input",{type:"checkbox",id:"useCustomEmailCheckbox","onUpdate:modelValue":e[1]||(e[1]=r=>f.value=r),class:"simple-checkbox-input"},null,512),[[pe,f.value]]),e[12]||(e[12]=t("label",{for:"useCustomEmailCheckbox",class:"simple-checkbox-label"}," Use different email address ",-1))]),_.value?(u(),c("small",je,p(_.value),1)):g("",!0),t("small",He,p(f.value?"Product license will be sent to the custom email above":`Product license will be sent to your registered email: ${(o=x(m))==null?void 0:o.email}`),1)]),t("div",Ke,[e[16]||(e[16]=t("label",{for:"quantity"},"Quantity",-1)),t("div",Ye,[t("button",{onClick:z,class:"quantity-btn",disabled:n.value<=1},"-",8,Je),Q(t("input",{type:"number",id:"quantity","onUpdate:modelValue":e[2]||(e[2]=r=>n.value=r),min:"1",max:y.value,onBlur:b,onFocus:X,onInput:Z,onKeyup:fe(b,["enter"]),class:B(["quantity-input",{calculating:P.value}])},null,42,ze),[[me,n.value,void 0,{number:!0}]]),t("button",{onClick:J,class:"quantity-btn",disabled:n.value>=y.value},"+",8,Xe)]),t("div",Ze,[y.value>0?(u(),c("span",Ge,[e[14]||(e[14]=t("i",{class:"fas fa-box"},null,-1)),q(" "+p(y.value)+" licenses available ",1)])):(u(),c("span",We,e[15]||(e[15]=[t("i",{class:"fas fa-exclamation-triangle"},null,-1),q(" Out of stock ")])))])]),t("div",et,[e[21]||(e[21]=t("div",{class:"summary-header"},[t("i",{class:"fas fa-calculator"}),t("h3",null,"Price Breakdown")],-1)),t("div",tt,[e[17]||(e[17]=t("span",null,[t("i",{class:"fas fa-tag"}),q(" Product Price")],-1)),t("span",st,p(x(V)($.value)),1)]),t("div",at,[e[18]||(e[18]=t("span",null,[t("i",{class:"fas fa-boxes"}),q(" Quantity")],-1)),t("span",ot,p(C.value)+" "+p(C.value>1?"licenses":"license"),1)]),e[22]||(e[22]=t("div",{class:"summary-divider"},null,-1)),t("div",lt,[e[19]||(e[19]=t("span",null,[t("i",{class:"fas fa-wallet"}),q(),t("strong",null,"Total Amount")],-1)),t("span",nt,p(x(V)(A.value)),1)]),C.value>1?(u(),c("div",it,[e[20]||(e[20]=t("i",{class:"fas fa-piggy-bank"},null,-1)),t("span",null,p(C.value)+" licenses for "+p(x(V)(A.value)),1)])):g("",!0)]),t("button",{onClick:ee,class:"galaxy-button-primary pay-button"},e[23]||(e[23]=[t("span",{class:"button-text"},"Complete Purchase",-1),t("span",{class:"button-icon"},"→",-1)])),e[25]||(e[25]=t("div",{class:"payment-info"},[t("p",null,"Secure payment processing by Midtrans"),t("div",{class:"payment-icons"},[t("img",{src:he,alt:"QRIS",class:"payment-icon qris-logo"})]),t("p",{class:"payment-note"},"Pay via QRIS, e-wallet, virtual account, or credit card")],-1))])])])):(u(),c("div",rt,[e[26]||(e[26]=t("p",null,"Product not found.",-1)),t("button",{class:"galaxy-button-secondary",onClick:e[3]||(e[3]=r=>s.$router.push("/"))},"Return to Home")]))])]))])}}},mt=le(ut,[["__scopeId","data-v-8320c4a2"]]);export{mt as default};
